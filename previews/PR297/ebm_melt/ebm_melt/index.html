<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Halfar-EBM-Water · Decapodes.jl</title><meta name="title" content="Halfar-EBM-Water · Decapodes.jl"/><meta property="og:title" content="Halfar-EBM-Water · Decapodes.jl"/><meta property="twitter:title" content="Halfar-EBM-Water · Decapodes.jl"/><meta name="description" content="Documentation for Decapodes.jl."/><meta property="og:description" content="Documentation for Decapodes.jl."/><meta property="twitter:description" content="Documentation for Decapodes.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><script src="../../assets/analytics.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Decapodes.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Decapodes.jl</a></li><li><a class="tocitem" href="../../overview/overview/">Overview</a></li><li><a class="tocitem" href="../../ice_dynamics/ice_dynamics/">Glacial Flow</a></li><li><span class="tocitem">Concepts</span><ul><li><a class="tocitem" href="../../concepts/equations/">Equations</a></li><li><a class="tocitem" href="../../concepts/composition/">Composition</a></li><li><a class="tocitem" href="../../concepts/meshes/">Meshes</a></li><li><a class="tocitem" href="../../concepts/generate/">Custom Operators</a></li></ul></li><li><span class="tocitem">Zoo</span><ul><li><a class="tocitem" href="../../navier_stokes/ns/">Vortices</a></li><li><a class="tocitem" href="../../harmonics/harmonics/">Harmonics</a></li><li><a class="tocitem" href="../../ch/cahn-hilliard/">Cahn-Hilliard</a></li><li><a class="tocitem" href="../../brussel/brussel/">Brusselator</a></li><li><a class="tocitem" href="../../klausmeier/klausmeier/">Klausmeier</a></li><li><a class="tocitem" href="../../cism/cism/">CISM v2.1</a></li><li><a class="tocitem" href="../../grigoriev/grigoriev/">Grigoriev Ice Cap</a></li><li><a class="tocitem" href="../../bsh/budyko_sellers_halfar/">Budyko-Sellers-Halfar</a></li><li class="is-active"><a class="tocitem" href>Halfar-EBM-Water</a><ul class="internal"><li><a class="tocitem" href="#Load-data"><span>Load data</span></a></li><li><a class="tocitem" href="#Define-the-model"><span>Define the model</span></a></li><li><a class="tocitem" href="#Define-initial-conditions"><span>Define initial conditions</span></a></li><li><a class="tocitem" href="#Generate-and-run-simulation"><span>Generate and run simulation</span></a></li><li><a class="tocitem" href="#Visualize"><span>Visualize</span></a></li></ul></li><li><a class="tocitem" href="../../halmo/halmo/">Halfar-NS</a></li><li><a class="tocitem" href="../../nhs/nhs_lite/">NHS</a></li><li><a class="tocitem" href="../../poiseuille/poiseuille/">Pipe Flow</a></li><li><a class="tocitem" href="../../fokker_planck/fokker_planck/">Fokker-Planck</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/chemistry/gray_scott/">Gray-Scott</a></li><li><a class="tocitem" href="../../examples/oncology/tumor_proliferation_invasion/">Oncology</a></li><li><a class="tocitem" href="../../examples/mhd/">MHD</a></li></ul></li><li><a class="tocitem" href="../../bc/bc_debug/">Misc Features</a></li><li><a class="tocitem" href="../../faq/faq/">FAQ</a></li><li><a class="tocitem" href="../../ascii/">ASCII Operators</a></li><li><a class="tocitem" href="../../canon/">Canonical Models</a></li><li><a class="tocitem" href="../../api/">Library Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Zoo</a></li><li class="is-active"><a href>Halfar-EBM-Water</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Halfar-EBM-Water</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/AlgebraicJulia/Decapodes.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/AlgebraicJulia/Decapodes.jl/blob/main/docs/src/ebm_melt/ebm_melt.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Halfar-EBM-Water"><a class="docs-heading-anchor" href="#Halfar-EBM-Water">Halfar-EBM-Water</a><a id="Halfar-EBM-Water-1"></a><a class="docs-heading-anchor-permalink" href="#Halfar-EBM-Water" title="Permalink"></a></h1><p>This docs page demonsrates a composition of the Halfar model of ice dynamics with the Budyko-Sellers energy-balance model (EBM) defining temperature dynamics. Surface temperature affects the rate at which ice diffuses, and melts ice into a water density term. This water density then diffuses across the domain.</p><p>We execute these dynamics on real sea ice thickness data provided by the Polar Science Center.</p><pre><code class="language-julia hljs"># Import Dependencies

# AlgebraicJulia Dependencies
using Catlab
using Catlab.Graphics
using CombinatorialSpaces
using DiagrammaticEquations
using Decapodes

# External Dependencies
using ComponentArrays
using CoordRefSystems
using CairoMakie
using LinearAlgebra
using MLStyle
using NearestNeighbors
using NetCDF
using OrdinaryDiffEq
Point3D = Point3{Float64}</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">GeometryBasics.Point{3, Float64}</code></pre><p>First, we load a mesh. We will execute these dynamics on the sphere:</p><pre><code class="language-julia hljs"># Load a mesh
s_plots = loadmesh(Icosphere(7));
s = EmbeddedDeltaDualComplex2D{Bool, Float64, Point3D}(s_plots);
subdivide_duals!(s, Barycenter());
wireframe(s_plots)</code></pre><img src="f6093686.png" alt="Example block output"/><h2 id="Load-data"><a class="docs-heading-anchor" href="#Load-data">Load data</a><a id="Load-data-1"></a><a class="docs-heading-anchor-permalink" href="#Load-data" title="Permalink"></a></h2><p>The data provided by the Polar Science Center is given as a NetCDF file. Ice thickness is a matrix with the same dimensions as a matrix provided Latitude and Longitude of the associated point on the Earth&#39;s surface. We need to convert between polar and Cartesian coordinates to use this data on our mesh.</p><pre><code class="language-julia hljs"># This data can be downloaded from source here:
# https://pscfiles.apl.uw.edu/axel/piomas20c/v1.0/monthly/piomas20c.heff.1901.2010.v1.0.nc
ice_thickness_file = &quot;piomas20c.heff.1901.2010.v1.0.nc&quot;
run(`curl -o $ice_thickness_file https://cise.ufl.edu/&quot;~&quot;luke.morris/piomas20c.heff.1901.2010.v1.0.nc`)

# Use ncinfo(ice_thickness_file) to interactively get information on variables.
# Sea ice thickness (&quot;sit&quot;) has dimensions of [y, x, time].
# y,x index into &quot;Latitude&quot; and &quot;Longitude&quot; variables.
# Time is in units of days since 1901-01-01.
lat = ncread(ice_thickness_file, &quot;Latitude&quot;)
lon = ncread(ice_thickness_file, &quot;Longitude&quot;)
sit = ncread(ice_thickness_file, &quot;sit&quot;)

# Convert latitude from [90, -90] to [0, 180] for convenience.
lat .= -lat .+ 90

# Convert mesh points from Cartesian to spherical coordinates.
p_sph = map(point(s)) do p
  p = convert(Spherical, Cartesian(p...))
  [rad2deg(p.θ).val, rad2deg(p.ϕ).val]
end

# Note: You can instead use an algebraic parameterization, rather than nearest-neighbor interpolation.
lat, lon = lat[:], lon[:]
ll = hcat(lat, lon)&#39;
kdt = KDTree(ll)
sit_sph_idxs = map(p_sph) do p
  nn(kdt, p)[1]
end

sit_sph = map(sit_sph_idxs, p_sph) do i, p
  ((p[1] &gt; maximum(lat)) || isnan(sit[i])) ? 0.0f0 : sit[i]
end

f = Figure()
ax = LScene(f[1,1], scenekw=(lights=[],))
update_cam!(ax.scene, Vec3f(0,0,0.8), Vec3f(0,0,0), Vec3f(0, 1, 1))
msh = mesh!(ax, s_plots, color=sit_sph, colormap=Reverse(:redsblues))
Colorbar(f[1,2], msh)
f</code></pre><img src="81e2a06f.png" alt="Example block output"/><h2 id="Define-the-model"><a class="docs-heading-anchor" href="#Define-the-model">Define the model</a><a id="Define-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-model" title="Permalink"></a></h2><p>Here, the Halfar model of ice dynamics is recalled, as well as the Budyko-Sellers EBM. These these models are composed individually. They are then coupled together via <code>warming</code> and <code>melting</code> components.</p><pre><code class="language-julia hljs">halfar_eq2 = @decapode begin
  (h, melt)::Form0
  Γ::Form1
  n::Constant

  ∂ₜ(h)  == ∘(⋆, d, ⋆)(Γ * d(h) * avg₀₁(mag(♯ᵖᵖ(d(h)))^(n-1)) * avg₀₁(h^(n+2))) - melt
end

glens_law = @decapode begin
  (A,Γ)::Form1
  (ρ,g,n)::Constant

  Γ == (2/(n+2))*A*(ρ*g)^n
end

ice_dynamics_composition_diagram = @relation () begin
  dynamics(Γ,n)
  stress(Γ,n)
end

ice_dynamics = apex(oapply(ice_dynamics_composition_diagram,
  [Open(halfar_eq2, [:Γ,:n]),
   Open(glens_law, [:Γ,:n])]))

draw_composition(ice_dynamics_composition_diagram)</code></pre><img src='data:image/svg+xml;utf-8,<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (0)
 -->
<!-- Title: G Pages: 1 -->
<svg width="230pt" height="251pt"
 viewBox="0.00 0.00 230.10 251.10" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 247.0976)">
<title>G</title>
<polygon fill="%23ffffff" stroke="transparent" points="-4,4 -4,-247.0976 226.0976,-247.0976 226.0976,4 -4,4"/>
<!-- n1 -->
<g id="box1" class="node">
<title>n1</title>
<ellipse fill="none" stroke="%23000000" cx="116.0488" cy="-18" rx="45.1548" ry="18"/>
<text text-anchor="middle" x="116.0488" y="-14.3" font-family="Serif" font-size="14.00" fill="%23000000">dynamics</text>
</g>
<!-- n3 -->
<!-- junction -->
<g id="junction1" class="node">
<title>n3</title>
<ellipse fill="%23000000" stroke="%23000000" cx="12.5" cy="-121.5488" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="5" y="-127.8488" font-family="Serif" font-size="14.00" fill="%23000000">Γ</text>
</g>
<!-- n1&%2345;&%2345;n3 -->
<g id="edge1" class="edge">
<title>n1&%2345;&%2345;n3</title>
<path fill="none" stroke="%23000000" d="M98.9498,-35.099C72.7559,-61.2929 24.6468,-109.402 14.4363,-119.6125"/>
</g>
<!-- n4 -->
<!-- junction -->
<g id="junction2" class="node">
<title>n4</title>
<ellipse fill="%23000000" stroke="%23000000" cx="219.5976" cy="-121.5488" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="212.0976" y="-127.8488" font-family="Serif" font-size="14.00" fill="%23000000">n</text>
</g>
<!-- n1&%2345;&%2345;n4 -->
<g id="edge3" class="edge">
<title>n1&%2345;&%2345;n4</title>
<path fill="none" stroke="%23000000" d="M133.1478,-35.099C159.3418,-61.2929 207.4508,-109.402 217.6614,-119.6125"/>
</g>
<!-- n2 -->
<g id="box2" class="node">
<title>n2</title>
<ellipse fill="none" stroke="%23000000" cx="116.0488" cy="-225.0976" rx="30.7213" ry="18"/>
<text text-anchor="middle" x="116.0488" y="-221.3976" font-family="Serif" font-size="14.00" fill="%23000000">stress</text>
</g>
<!-- n2&%2345;&%2345;n3 -->
<g id="edge2" class="edge">
<title>n2&%2345;&%2345;n3</title>
<path fill="none" stroke="%23000000" d="M100.322,-209.3708C74.5228,-183.5716 25.0169,-134.0657 14.4961,-123.5449"/>
</g>
<!-- n2&%2345;&%2345;n4 -->
<g id="edge4" class="edge">
<title>n2&%2345;&%2345;n4</title>
<path fill="none" stroke="%23000000" d="M131.7756,-209.3708C157.5748,-183.5716 207.0807,-134.0657 217.6015,-123.5449"/>
</g>
</g>
</svg>
'/><p>The composition pattern tells you how to couple the variables and introduces namespaces that we will use later when supplying initial conditions.</p><p>The following code creates the Budyko-Sellers model as a composite of individual terms.</p><pre><code class="language-julia hljs">energy_balance = @decapode begin
  (Tₛ, ASR, OLR, HT)::Form0
  C::Constant

  ∂ₜ(Tₛ) == (ASR - OLR + HT) ./ C
end

absorbed_shortwave_radiation = @decapode begin
  (Q, ASR)::Form0
  α::Constant

  ASR == (1 .- α) .* Q
end

outgoing_longwave_radiation = @decapode begin
  (Tₛ, OLR)::Form0
  (A,B)::Constant

  OLR == A .+ (B .* Tₛ)
end

heat_transfer = @decapode begin
  (HT, Tₛ)::Form0
  (D,cosϕᵖ,cosϕᵈ)::Constant

  HT == (D ./ cosϕᵖ) .* ⋆(d(cosϕᵈ .* ⋆(d(Tₛ))))
end

insolation = @decapode begin
  Q::Form0
  cosϕᵖ::Constant

  Q == 450 * cosϕᵖ
end

budyko_sellers_composition_diagram = @relation () begin
  energy(Tₛ, ASR, OLR, HT)
  absorbed_radiation(Q, ASR)
  outgoing_radiation(Tₛ, OLR)
  diffusion(Tₛ, HT, cosϕᵖ)
  insolation(Q, cosϕᵖ)
end

budyko_sellers = apex(oapply(budyko_sellers_composition_diagram,
  [Open(energy_balance, [:Tₛ, :ASR, :OLR, :HT]),
   Open(absorbed_shortwave_radiation, [:Q, :ASR]),
   Open(outgoing_longwave_radiation, [:Tₛ, :OLR]),
   Open(heat_transfer, [:Tₛ, :HT, :cosϕᵖ]),
   Open(insolation, [:Q, :cosϕᵖ])]))

draw_composition(budyko_sellers_composition_diagram)</code></pre><img src='data:image/svg+xml;utf-8,<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (0)
 -->
<!-- Title: G Pages: 1 -->
<svg width="908pt" height="878pt"
 viewBox="0.00 0.00 907.86 877.85" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 873.8454)">
<title>G</title>
<polygon fill="%23ffffff" stroke="transparent" points="-4,4 -4,-873.8454 903.8592,-873.8454 903.8592,4 -4,4"/>
<!-- n1 -->
<g id="box1" class="node">
<title>n1</title>
<ellipse fill="none" stroke="%23000000" cx="393.1019" cy="-851.8454" rx="34.2855" ry="18"/>
<text text-anchor="middle" x="393.1019" y="-848.1454" font-family="Serif" font-size="14.00" fill="%23000000">energy</text>
</g>
<!-- n6 -->
<!-- junction -->
<g id="junction1" class="node">
<title>n6</title>
<ellipse fill="%23000000" stroke="%23000000" cx="632.3901" cy="-817.4409" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="622.3901" y="-823.7409" font-family="Serif" font-size="14.00" fill="%23000000">Tₛ</text>
</g>
<!-- n1&%2345;&%2345;n6 -->
<g id="edge1" class="edge">
<title>n1&%2345;&%2345;n6</title>
<path fill="none" stroke="%23000000" d="M426.3739,-847.0616C486.7302,-838.3837 609.8791,-820.6775 629.6771,-817.831"/>
</g>
<!-- n7 -->
<!-- junction -->
<g id="junction2" class="node">
<title>n7</title>
<ellipse fill="%23000000" stroke="%23000000" cx="815.0917" cy="-195.2163" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="797.0917" y="-201.5163" font-family="Serif" font-size="14.00" fill="%23000000">ASR</text>
</g>
<!-- n1&%2345;&%2345;n7 -->
<g id="edge4" class="edge">
<title>n1&%2345;&%2345;n7</title>
<path fill="none" stroke="%23000000" d="M404.1722,-834.6197C468.1524,-735.0645 788.6141,-236.4163 813.5526,-197.6113"/>
</g>
<!-- n8 -->
<!-- junction -->
<g id="junction3" class="node">
<title>n8</title>
<ellipse fill="%23000000" stroke="%23000000" cx="883.2003" cy="-427.1727" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="864.2003" y="-433.4727" font-family="Serif" font-size="14.00" fill="%23000000">OLR</text>
</g>
<!-- n1&%2345;&%2345;n8 -->
<g id="edge6" class="edge">
<title>n1&%2345;&%2345;n8</title>
<path fill="none" stroke="%23000000" d="M411.126,-836.2274C495.7469,-762.9029 850.7751,-455.2693 881.1291,-428.9674"/>
</g>
<!-- n9 -->
<!-- junction -->
<g id="junction4" class="node">
<title>n9</title>
<ellipse fill="%23000000" stroke="%23000000" cx="173.1993" cy="-751.4193" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="159.1993" y="-757.7193" font-family="Serif" font-size="14.00" fill="%23000000">HT</text>
</g>
<!-- n1&%2345;&%2345;n9 -->
<g id="edge8" class="edge">
<title>n1&%2345;&%2345;n9</title>
<path fill="none" stroke="%23000000" d="M367.0126,-839.9308C313.3135,-815.4073 193.9092,-760.8772 175.5801,-752.5065"/>
</g>
<!-- n2 -->
<g id="box2" class="node">
<title>n2</title>
<ellipse fill="none" stroke="%23000000" cx="632.3901" cy="-36.9045" rx="86.5669" ry="18"/>
<text text-anchor="middle" x="632.3901" y="-33.2045" font-family="Serif" font-size="14.00" fill="%23000000">absorbed_radiation</text>
</g>
<!-- n2&%2345;&%2345;n7 -->
<g id="edge5" class="edge">
<title>n2&%2345;&%2345;n7</title>
<path fill="none" stroke="%23000000" d="M652.6405,-54.4515C696.4928,-92.4497 797.5522,-180.0182 813.0751,-193.4689"/>
</g>
<!-- n10 -->
<!-- junction -->
<g id="junction5" class="node">
<title>n10</title>
<ellipse fill="%23000000" stroke="%23000000" cx="393.1019" cy="-2.5" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="384.1019" y="-8.8" font-family="Serif" font-size="14.00" fill="%23000000">Q</text>
</g>
<!-- n2&%2345;&%2345;n10 -->
<g id="edge10" class="edge">
<title>n2&%2345;&%2345;n10</title>
<path fill="none" stroke="%23000000" d="M560.9199,-26.6286C497.5709,-17.5204 412.5911,-5.3021 395.983,-2.9142"/>
</g>
<!-- n3 -->
<g id="box3" class="node">
<title>n3</title>
<ellipse fill="none" stroke="%23000000" cx="815.0917" cy="-659.1291" rx="84.5356" ry="18"/>
<text text-anchor="middle" x="815.0917" y="-655.4291" font-family="Serif" font-size="14.00" fill="%23000000">outgoing_radiation</text>
</g>
<!-- n3&%2345;&%2345;n6 -->
<g id="edge2" class="edge">
<title>n3&%2345;&%2345;n6</title>
<path fill="none" stroke="%23000000" d="M794.8414,-676.6761C750.9891,-714.6743 649.9297,-802.2428 634.4068,-815.6935"/>
</g>
<!-- n3&%2345;&%2345;n8 -->
<g id="edge7" class="edge">
<title>n3&%2345;&%2345;n8</title>
<path fill="none" stroke="%23000000" d="M820.4361,-640.9278C835.3004,-590.3047 876.4359,-450.2102 882.46,-429.6937"/>
</g>
<!-- n4 -->
<g id="box4" class="node">
<title>n4</title>
<ellipse fill="none" stroke="%23000000" cx="42.5" cy="-548.0472" rx="41.5911" ry="18"/>
<text text-anchor="middle" x="42.5" y="-544.3472" font-family="Serif" font-size="14.00" fill="%23000000">diffusion</text>
</g>
<!-- n4&%2345;&%2345;n6 -->
<g id="edge3" class="edge">
<title>n4&%2345;&%2345;n6</title>
<path fill="none" stroke="%23000000" d="M71.3509,-561.2229C184.6941,-612.985 594.9521,-800.3436 629.9994,-816.3491"/>
</g>
<!-- n4&%2345;&%2345;n9 -->
<g id="edge9" class="edge">
<title>n4&%2345;&%2345;n9</title>
<path fill="none" stroke="%23000000" d="M53.8701,-565.7393C83.1842,-611.3529 159.8628,-730.6672 171.6649,-749.0317"/>
</g>
<!-- n11 -->
<!-- junction -->
<g id="junction6" class="node">
<title>n11</title>
<ellipse fill="%23000000" stroke="%23000000" cx="42.5" cy="-306.2982" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="20" y="-312.5982" font-family="Serif" font-size="14.00" fill="%23000000">cosϕᵖ</text>
</g>
<!-- n4&%2345;&%2345;n11 -->
<g id="edge12" class="edge">
<title>n4&%2345;&%2345;n11</title>
<path fill="none" stroke="%23000000" d="M42.5,-529.8767C42.5,-477.8279 42.5,-330.5281 42.5,-308.95"/>
</g>
<!-- n5 -->
<g id="box5" class="node">
<title>n5</title>
<ellipse fill="none" stroke="%23000000" cx="173.1993" cy="-102.9261" rx="45.8316" ry="18"/>
<text text-anchor="middle" x="173.1993" y="-99.2261" font-family="Serif" font-size="14.00" fill="%23000000">insolation</text>
</g>
<!-- n5&%2345;&%2345;n10 -->
<g id="edge11" class="edge">
<title>n5&%2345;&%2345;n10</title>
<path fill="none" stroke="%23000000" d="M203.3147,-89.1729C258.8354,-63.8174 373.2811,-11.5518 390.8244,-3.5401"/>
</g>
<!-- n5&%2345;&%2345;n11 -->
<g id="edge13" class="edge">
<title>n5&%2345;&%2345;n11</title>
<path fill="none" stroke="%23000000" d="M161.8293,-120.6183C132.5152,-166.2319 55.8365,-285.5462 44.0344,-303.9106"/>
</g>
</g>
</svg>
'/><p>Our full model can then be composed by adding terms for melting of water. We will assume that the meltwater is transported by diffusion because the transport of meltwater is so much faster than the melting process itself. If you wanted to increase the physical realism of this model, using a different model of melting and water transport would be a good place to start.</p><pre><code class="language-julia hljs">warming = @decapode begin
  Tₛ::Form0
  A::Form1

  A == avg₀₁(5.8282*10^(-0.236 * Tₛ)*1.01e-19)
end

melting = @decapode begin
  (Tₛ, h, melt, water)::Form0
  Dₕ₂ₒ::Constant

  melt == (Tₛ - 15)*1e-16*h
  ∂ₜ(water) == melt + Dₕ₂ₒ*Δ(water)
end

budyko_sellers_halfar_water_composition_diagram = @relation () begin
  budyko_sellers(Tₛ)
  warming(A, Tₛ)
  melting(Tₛ, h, melt)
  halfar(A, h, melt)
end

draw_composition(budyko_sellers_halfar_water_composition_diagram)</code></pre><img src='data:image/svg+xml;utf-8,<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (0)
 -->
<!-- Title: G Pages: 1 -->
<svg width="596pt" height="369pt"
 viewBox="0.00 0.00 595.90 368.55" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 364.5466)">
<title>G</title>
<polygon fill="%23ffffff" stroke="transparent" points="-4,4 -4,-364.5466 591.896,-364.5466 591.896,4 -4,4"/>
<!-- n1 -->
<g id="box1" class="node">
<title>n1</title>
<ellipse fill="none" stroke="%23000000" cx="68.2849" cy="-172.7733" rx="68.0705" ry="18"/>
<text text-anchor="middle" x="68.2849" y="-169.0733" font-family="Serif" font-size="14.00" fill="%23000000">budyko_sellers</text>
</g>
<!-- n5 -->
<!-- junction -->
<g id="junction1" class="node">
<title>n5</title>
<ellipse fill="%23000000" stroke="%23000000" cx="225.8658" cy="-96.9946" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="215.8658" y="-103.2946" font-family="Serif" font-size="14.00" fill="%23000000">Tₛ</text>
</g>
<!-- n1&%2345;&%2345;n5 -->
<g id="edge1" class="edge">
<title>n1&%2345;&%2345;n5</title>
<path fill="none" stroke="%23000000" d="M101.319,-156.8876C142.8338,-136.9236 210.2846,-104.4874 223.5574,-98.1047"/>
</g>
<!-- n2 -->
<g id="box2" class="node">
<title>n2</title>
<ellipse fill="none" stroke="%23000000" cx="492.1159" cy="-36.2247" rx="42.2678" ry="18"/>
<text text-anchor="middle" x="492.1159" y="-32.5247" font-family="Serif" font-size="14.00" fill="%23000000">warming</text>
</g>
<!-- n2&%2345;&%2345;n5 -->
<g id="edge2" class="edge">
<title>n2&%2345;&%2345;n5</title>
<path fill="none" stroke="%23000000" d="M454.5335,-44.8027C386.5885,-60.3107 248.4635,-91.8368 228.3348,-96.431"/>
</g>
<!-- n6 -->
<!-- junction -->
<g id="junction2" class="node">
<title>n6</title>
<ellipse fill="%23000000" stroke="%23000000" cx="344.3582" cy="-2.5" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="336.3582" y="-8.8" font-family="Serif" font-size="14.00" fill="%23000000">A</text>
</g>
<!-- n2&%2345;&%2345;n6 -->
<g id="edge4" class="edge">
<title>n2&%2345;&%2345;n6</title>
<path fill="none" stroke="%23000000" d="M454.4481,-27.6273C415.8013,-18.8064 359.5909,-5.9767 346.9473,-3.0909"/>
</g>
<!-- n3 -->
<g id="box3" class="node">
<title>n3</title>
<ellipse fill="none" stroke="%23000000" cx="225.8658" cy="-248.5521" rx="37.1717" ry="18"/>
<text text-anchor="middle" x="225.8658" y="-244.8521" font-family="Serif" font-size="14.00" fill="%23000000">melting</text>
</g>
<!-- n3&%2345;&%2345;n5 -->
<g id="edge3" class="edge">
<title>n3&%2345;&%2345;n5</title>
<path fill="none" stroke="%23000000" d="M225.8658,-230.2707C225.8658,-194.055 225.8658,-115.3352 225.8658,-99.7188"/>
</g>
<!-- n7 -->
<!-- junction -->
<g id="junction3" class="node">
<title>n7</title>
<ellipse fill="%23000000" stroke="%23000000" cx="344.3582" cy="-343.0466" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="336.8582" y="-349.3466" font-family="Serif" font-size="14.00" fill="%23000000">h</text>
</g>
<!-- n3&%2345;&%2345;n7 -->
<g id="edge6" class="edge">
<title>n3&%2345;&%2345;n7</title>
<path fill="none" stroke="%23000000" d="M245.1674,-263.9446C275.0712,-287.7921 330.3883,-331.906 342.1312,-341.2706"/>
</g>
<!-- n8 -->
<!-- junction -->
<g id="junction4" class="node">
<title>n8</title>
<ellipse fill="%23000000" stroke="%23000000" cx="492.1159" cy="-309.3219" rx="2.5" ry="2.5"/>
<text text-anchor="middle" x="473.1159" y="-315.6219" font-family="Serif" font-size="14.00" fill="%23000000">melt</text>
</g>
<!-- n3&%2345;&%2345;n8 -->
<g id="edge8" class="edge">
<title>n3&%2345;&%2345;n8</title>
<path fill="none" stroke="%23000000" d="M259.5866,-256.2486C325.9134,-271.3873 468.7261,-303.9834 489.5595,-308.7384"/>
</g>
<!-- n4 -->
<g id="box4" class="node">
<title>n4</title>
<ellipse fill="none" stroke="%23000000" cx="557.8742" cy="-172.7733" rx="30.0436" ry="18"/>
<text text-anchor="middle" x="557.8742" y="-169.0733" font-family="Serif" font-size="14.00" fill="%23000000">halfar</text>
</g>
<!-- n4&%2345;&%2345;n6 -->
<g id="edge5" class="edge">
<title>n4&%2345;&%2345;n6</title>
<path fill="none" stroke="%23000000" d="M539.67,-158.2559C491.6664,-119.9743 364.1079,-18.2498 346.4073,-4.134"/>
</g>
<!-- n4&%2345;&%2345;n7 -->
<g id="edge7" class="edge">
<title>n4&%2345;&%2345;n7</title>
<path fill="none" stroke="%23000000" d="M539.67,-187.2907C491.6664,-225.5723 364.1079,-327.2969 346.4073,-341.4126"/>
</g>
<!-- n4&%2345;&%2345;n8 -->
<g id="edge9" class="edge">
<title>n4&%2345;&%2345;n8</title>
<path fill="none" stroke="%23000000" d="M549.5459,-190.0673C533.6484,-223.0789 499.9598,-293.0339 493.2808,-306.903"/>
</g>
</g>
</svg>
'/><pre><code class="language-julia hljs">budyko_sellers_halfar_water = apex(oapply(budyko_sellers_halfar_water_composition_diagram,
  [Open(budyko_sellers, [:Tₛ]),
   Open(warming, [:A, :Tₛ]),
   Open(melting, [:Tₛ, :h, :melt]),
   Open(ice_dynamics, [:stress_A, :dynamics_h, :dynamics_melt])]))</code></pre><h2 id="Define-initial-conditions"><a class="docs-heading-anchor" href="#Define-initial-conditions">Define initial conditions</a><a id="Define-initial-conditions-1"></a><a class="docs-heading-anchor-permalink" href="#Define-initial-conditions" title="Permalink"></a></h2><p>The initial data must be specified for state variables, as well as constants and parameters.</p><pre><code class="language-julia hljs"># This is a primal 0-form, with values at vertices.
cosϕᵖ = map(x -&gt; cos(x[1]), point(s))
# This is a dual 0-form, with values at edge centers.
cosϕᵈ = map(edges(s)) do e
  (cos(point(s, src(s, e))[1]) + cos(point(s, tgt(s, e))[1])) / 2
end

α₀ = 0.354
α₂ = 0.25
α = map(point(s)) do ϕ
  α₀ + α₂*((1/2)*(3*ϕ[1]^2 - 1))
end
A = 210
B = 2
f = 0.70
ρ = 1025
cw = 4186
H = 70
C = map(point(s)) do ϕ
  f * ρ * cw * H
end
D = 0.6

# Isothermal initial conditions:
Tₛ₀ = map(point(s)) do ϕ
  15.0
end

water = map(point(s)) do _
  0.0
end

Dₕ₂ₒ = 1e-16

n = 3
halfar_ρ = 910
g = 9.8

h₀ = sit_sph
# Store these values to be passed to the solver.
u₀ = ComponentArray(
  Tₛ = Tₛ₀,
  h = h₀,
  melting_water = water)

# The underscore-separated words are the namespaces that were introduced by oapply.
constants_and_parameters = (
  budyko_sellers_absorbed_radiation_α = α,
  budyko_sellers_outgoing_radiation_A = A,
  budyko_sellers_outgoing_radiation_B = B,
  budyko_sellers_energy_C = C,
  budyko_sellers_diffusion_D = D,
  budyko_sellers_cosϕᵖ = cosϕᵖ,
  budyko_sellers_diffusion_cosϕᵈ = cosϕᵈ,
  halfar_n = n,
  halfar_stress_ρ = halfar_ρ,
  halfar_stress_g = g,
  melting_Dₕ₂ₒ = Dₕ₂ₒ)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(budyko_sellers_absorbed_radiation_α = [0.22899999999999998, 0.42535266092031276, 0.25764637028180315, 0.5289991931360366, 0.25764637028180315, 0.42535266092031276, 0.25764637028180315, 0.42535266092031276, 0.42535266092031276, 0.25764637028180315  …  0.387014639019278, 0.39079002740384394, 0.39446949931134234, 0.39804978415654657, 0.4015290013696021, 0.4049054245973259, 0.4081777128058527, 0.41134515532583504, 0.4144074574086275, 0.41736448182568686], budyko_sellers_outgoing_radiation_A = 210, budyko_sellers_outgoing_radiation_B = 2, budyko_sellers_energy_C = [2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8  …  2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8, 2.1024185e8], budyko_sellers_diffusion_D = 0.6, budyko_sellers_cosϕᵖ = [1.0, 0.749422440684354, 0.9620473663831968, 0.6259665625366934, 0.9620473663831968, 0.749422440684354, 0.9620473663831968, 0.749422440684354, 0.749422440684354, 0.9620473663831968  …  0.7966087923365375, 0.7919251348174569, 0.7873682511825326, 0.7829415737752563, 0.7786468114880544, 0.7744854867734084, 0.7704586539274855, 0.7665666026070558, 0.7628091269438364, 0.7591858457675976], budyko_sellers_diffusion_cosϕᵈ = [0.9999952563232682, 0.9999627438703578, 0.9999674875470896, 0.751129596343835, 0.7490592463734626, 0.7473520907139816, 0.9999455828401413, 0.999950326516873, 0.9999455828401413, 0.9999952563232682  …  0.7711632721101841, 0.7691498556872226, 0.7671723092100983, 0.7652262835498834, 0.7633171694219378, 0.7614384315903281, 0.7595968838503896, 0.7577852432622703, 0.7560112988854568, 0.7542664286311203], halfar_n = 3, halfar_stress_ρ = 910, halfar_stress_g = 9.8, melting_Dₕ₂ₒ = 1.0e-16)</code></pre><h2 id="Generate-and-run-simulation"><a class="docs-heading-anchor" href="#Generate-and-run-simulation">Generate and run simulation</a><a id="Generate-and-run-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Generate-and-run-simulation" title="Permalink"></a></h2><p>The composed model is generated and executed for 100 years. The model is run twice to demonstrate the speed of the model after the simulation code is precompiled by the first run.</p><p>We will save the final ice thickness data in a .jld2 file, an HDF5-compatible file format. We will also save the latitude and longitude of the points on the sphere.</p><pre><code class="language-julia hljs">sim = eval(gensim(budyko_sellers_halfar_water))
fₘ = sim(s, nothing, DiagonalHodge())

tₑ = 100.0

@info(&quot;Precompiling Solver&quot;)
prob = ODEProblem(fₘ, u₀, (0, 1e-4), constants_and_parameters)
soln = solve(prob, Tsit5())
soln.retcode != :Unstable || error(&quot;Solver was not stable&quot;)

@info(&quot;Solving&quot;)
prob = ODEProblem(fₘ, u₀, (0, tₑ), constants_and_parameters)
soln = solve(prob, Tsit5())
@show soln.retcode
@info(&quot;Done&quot;)

save(&quot;ice.jld2&quot;,
  Dict(&quot;lat&quot; =&gt; map(x -&gt; x[1], p_sph), &quot;lon&quot; =&gt; map(x -&gt; x[2], p_sph), &quot;ice&quot; =&gt; soln(tₑ).h))

(extrema(soln(0.0).h), extrema(soln(tₑ).h))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">((0.0, 5.88970947265625), (-6.339e-320, 4.2935936709316245))</code></pre><h2 id="Visualize"><a class="docs-heading-anchor" href="#Visualize">Visualize</a><a id="Visualize-1"></a><a class="docs-heading-anchor-permalink" href="#Visualize" title="Permalink"></a></h2><p>Let&#39;s visualize the initial conditions for ice height and the ice height after 100 years.</p><h3 id="Initial-ice-height"><a class="docs-heading-anchor" href="#Initial-ice-height">Initial ice height</a><a id="Initial-ice-height-1"></a><a class="docs-heading-anchor-permalink" href="#Initial-ice-height" title="Permalink"></a></h3><pre><code class="language-julia hljs">f = Figure()
ax = LScene(f[1,1], scenekw=(lights=[],))
update_cam!(ax.scene, Vec3f(0,0,0.8), Vec3f(0,0,0), Vec3f(0, 1, 1))
msh = mesh!(ax, s_plots, color=soln.u[begin].h, colormap=Reverse(:redsblues))
Colorbar(f[1,2], msh)
f</code></pre><img src="81e2a06f-001.png" alt="Example block output"/><h3 id="Ice-height-after-100-years"><a class="docs-heading-anchor" href="#Ice-height-after-100-years">Ice height after 100 years</a><a id="Ice-height-after-100-years-1"></a><a class="docs-heading-anchor-permalink" href="#Ice-height-after-100-years" title="Permalink"></a></h3><pre><code class="language-julia hljs">f = Figure()
ax = LScene(f[1,1], scenekw=(lights=[],))
update_cam!(ax.scene, Vec3f(0,0,0.8), Vec3f(0,0,0), Vec3f(0, 1, 1))
msh = mesh!(ax, s_plots, color=soln.u[end].h, colorrange=extrema(soln.u[begin].h), colormap=Reverse(:redsblues))
Colorbar(f[1,2], msh)
f</code></pre><img src="14195a31.png" alt="Example block output"/><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Process(`<span class="sgr4">rm</span> <span class="sgr4">piomas20c.heff.1901.2010.v1.0.nc</span>`, ProcessExited(0))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../bsh/budyko_sellers_halfar/">« Budyko-Sellers-Halfar</a><a class="docs-footer-nextpage" href="../../halmo/halmo/">Halfar-NS »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.1 on <span class="colophon-date" title="Friday 7 March 2025 17:31">Friday 7 March 2025</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
